<div class="kds-container">
    <!-- Top Bar -->
    <div class="kds-header" [class.mobile-header]="isHandset$ | async">
        <div class="brand" *ngIf="!(isHandset$ | async)">
            <mat-icon>restaurant_menu</mat-icon>
            <h1>Tablero de Cocina</h1>
        </div>

        <div class="station-filter" [class.mobile-filters]="isHandset$ | async">
            <!-- Chips for Desktop -->
            <mat-chip-listbox *ngIf="!(isHandset$ | async)" aria-label="Station Selection" [(value)]="selectedStationId"
                (change)="onStationChange($event)">
                <mat-chip-option value="all" color="accent">Todos</mat-chip-option>
                <mat-chip-option *ngFor="let station of stations$ | async" [value]="station.id" color="primary">
                    {{ station.name }}
                </mat-chip-option>
            </mat-chip-listbox>

            <!-- Aesthetic minimalist dropdown for Mobile -->
            <div *ngIf="isHandset$ | async" class="aesthetic-filter-container">
                <mat-select [(value)]="selectedStationId" (selectionChange)="onStationChange($event)"
                    class="glass-pill-select" panelClass="dark-panel">
                    <mat-option value="all">Todas</mat-option>
                    <mat-option *ngFor="let station of stations$ | async" [value]="station.id">
                        {{ station.name }}
                    </mat-option>
                </mat-select>
            </div>
        </div>

        <div class="actions" *ngIf="!(isHandset$ | async)">
            <button mat-icon-button color="warn" (click)="clearAll()" matTooltip="Limpiar Pantalla">
                <mat-icon>delete_sweep</mat-icon>
            </button>
        </div>
    </div>

    <!-- Stats / Info Bar (Optional) -->
    <div class="kds-stats" *ngIf="orders.length > 0">
        <span>Pendientes: <strong>{{ orders.length }}</strong></span>
    </div>

    <!-- Orders Grid -->
    <div class="kds-grid" [class.mobile-grid]="isHandset$ | async">
        <div *ngFor="let order of orders; trackBy: trackByOrderId" class="kds-card" [ngClass]="getPriority(order)"
            [class.mobile-card]="isHandset$ | async">

            <div class="card-header">
                <div class="table-info" [class.mobile-table-info]="isHandset$ | async">
                    <span class="label" *ngIf="!(isHandset$ | async)">Mesa</span>
                    <span class="number">Mesa {{ order.table?.number || '?' }}</span>
                </div>
                <div class="timer-badge" [class.mobile-timer]="isHandset$ | async">
                    <mat-icon *ngIf="!(isHandset$ | async)">timer</mat-icon>
                    {{ getElapsedTime(order.created_at) }}
                </div>
            </div>

            <div class="card-body">
                <div class="order-meta">
                    <span class="order-id">#{{ order.id.substring(0,4) }}</span>
                    <span class="waiter" *ngIf="order.waiter_id">Mesero: {{ order.waiter_id.substring(0,4) }}</span>
                </div>

                <mat-divider></mat-divider>

                <div class="items-list">
                    <div *ngFor="let item of order.order_items" class="item-row"
                        [class.dimmed]="!isItemForCurrentStation(item)" [class.ready]="item.status === 'ready'"
                        (click)="toggleItemStatus(item)">

                        <!-- Checkbox Logic (Only enable if it's my station or I'm viewing All) -->
                        <div class="status-indicator">
                            <mat-icon *ngIf="item.status === 'ready'">check_circle</mat-icon>
                            <mat-icon *ngIf="item.status !== 'ready'"
                                class="radio-off">radio_button_unchecked</mat-icon>
                        </div>

                        <div class="item-details">
                            <span class="qty">{{ item.quantity }}x</span>
                            <span class="name">{{ item.products?.name }}</span>
                            <span class="notes" *ngIf="item.notes">{{ item.notes }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-footer">
                <!-- Convenience Button: Mark All MINE Ready -->
                <button mat-flat-button color="primary" class="btn-block" [class.mobile-btn]="isHandset$ | async"
                    (click)="markStationItemsReady(order)">
                    <mat-icon>done_all</mat-icon>
                    <span>{{ (isHandset$ | async) ? 'Listo' : 'ESTACI√ìN LISTA' }}</span>
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="progress-line" [style.width]="getOrderProgress(order) + '%'"></div>
        </div>

        <!-- Empty State -->
        <div *ngIf="orders.length === 0" class="empty-state">
            <div class="illustration">üç≥</div>
            <h2>Todo Limpio</h2>
            <p>Esperando nuevos pedidos...</p>
        </div>
    </div>
</div>