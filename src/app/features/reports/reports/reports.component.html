<div class="reports-container">
  <div class="page-header" id="report-header">
    <div class="header-content">
      <div class="brand-header">
        <div class="brand-icon">üçΩÔ∏è</div>
        <div>
          <h1 class="page-title">Man√° - Reportes Ejecutivos</h1>
          <p class="subtitle">{{ currentDate | date:'MMMM yyyy' | titlecase }}</p>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button mat-flat-button color="primary" (click)="loadStats()" [disabled]="isLoading">
        <mat-icon>{{ isLoading ? 'hourglass_empty' : 'refresh' }}</mat-icon>
        Actualizar
      </button>
      <button mat-stroked-button color="accent" (click)="exportToPDF()" [disabled]="isLoading || !stats">
        <mat-icon>picture_as_pdf</mat-icon>
        Exportar PDF
      </button>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-overlay">
    <mat-icon class="spinner">hourglass_empty</mat-icon>
    <p>Generando anal√≠ticas...</p>
  </div>

  <div *ngIf="!isLoading && stats" class="dashboard-grid" id="report-dashboard">

    <!-- Financial Summary Section -->
    <section class="section-header">
      <mat-icon>account_balance</mat-icon>
      <h2>Resumen Financiero</h2>
    </section>

    <div class="financial-grid">
      <mat-card class="metric-card income">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="metric-data">
            <span class="label">Ingresos Totales</span>
            <h2 class="value">{{ stats.totalIncome | currency:'CAD':'symbol-narrow':'1.0-0' }}</h2>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card expense">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>trending_down</mat-icon>
          </div>
          <div class="metric-data">
            <span class="label">Egresos Totales</span>
            <h2 class="value">{{ stats.totalExpenses | currency:'CAD':'symbol-narrow':'1.0-0' }}</h2>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card profit">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>savings</mat-icon>
          </div>
          <div class="metric-data">
            <span class="label">Utilidad Neta</span>
            <h2 class="value" [class.negative]="stats.netProfit < 0">
              {{ stats.netProfit | currency:'CAD':'symbol-narrow':'1.0-0' }}
            </h2>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card margin">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>percent</mat-icon>
          </div>
          <div class="metric-data">
            <span class="label">Margen de Utilidad</span>
            <h2 class="value" [class.negative]="stats.profitMargin < 0">
              {{ stats.profitMargin | number:'1.1-1' }}%
            </h2>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Sales Metrics Section -->
    <section class="section-header">
      <mat-icon>shopping_cart</mat-icon>
      <h2>M√©tricas de Ventas</h2>
    </section>

    <div class="sales-grid">
      <mat-card class="metric-card sales">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>payments</mat-icon>
          </div>
          <div class="metric-data">
            <span class="label">Ventas</span>
            <h2 class="value">{{ stats.totalSales | currency:'CAD':'symbol-narrow':'1.0-0' }}</h2>
            <span class="sub-label">{{ stats.orderCount }} pedidos</span>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card ticket">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>receipt_long</mat-icon>
          </div>
          <div class="metric-data">
            <span class="label">Ticket Promedio</span>
            <h2 class="value">{{ stats.averageTicket | currency:'CAD':'symbol-narrow':'1.0-0' }}</h2>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card items">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>inventory_2</mat-icon>
          </div>
          <div class="metric-data">
            <span class="label">Items Vendidos</span>
            <h2 class="value">{{ stats.itemsSold }}</h2>
            <span class="sub-label">{{ stats.avgItemsPerOrder | number:'1.1-1' }} por pedido</span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Operational Metrics Section -->
    <section class="section-header">
      <mat-icon>analytics</mat-icon>
      <h2>M√©tricas Operacionales</h2>
    </section>

    <div class="operational-grid">
      <mat-card class="metric-card customers">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>people</mat-icon>
          </div>
          <div class="metric-data">
            <span class="label">Clientes Atendidos</span>
            <h2 class="value">{{ stats.customerCount }}</h2>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card turnover">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>table_restaurant</mat-icon>
          </div>
          <div class="metric-data">
            <span class="label">Rotaci√≥n de Mesas</span>
            <h2 class="value">{{ stats.tableTurnoverRate | number:'1.1-1' }}</h2>
            <span class="sub-label">sesiones por mesa</span>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card attention">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>timer</mat-icon>
          </div>
          <div class="metric-data">
            <span class="label">Tiempo de Atenci√≥n</span>
            <h2 class="value">{{ stats.avgAttentionTime | number:'1.0-0' }} min</h2>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card prep">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>restaurant</mat-icon>
          </div>
          <div class="metric-data">
            <span class="label">Tiempo de Cocina</span>
            <h2 class="value">{{ stats.avgPrepTime | number:'1.0-0' }} min</h2>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Analytics Section -->
    <div class="analytics-container">
      <!-- Top Products -->
      <mat-card class="analytics-card top-products">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>trending_up</mat-icon>
            Top 5 Productos
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="top-products-list">
            <div *ngFor="let product of stats.topProducts; let i = index" class="product-item">
              <div class="rank">{{ i + 1 }}</div>
              <div class="product-info">
                <span class="name">{{ product.name }}</span>
                <span class="revenue">{{ product.totalRevenue | currency:'CAD':'symbol-narrow':'1.0-0' }}</span>
              </div>
              <div class="quantity-badge">
                {{ product.quantity }} u.
              </div>
              <div class="progress-bar-container">
                <div class="progress-bar" [style.width.%]="(product.totalRevenue / stats.totalSales) * 100 * 5"></div>
              </div>
            </div>
          </div>
          <div *ngIf="stats.topProducts.length === 0" class="empty-state">
            <mat-icon>query_stats</mat-icon>
            <p>No hay datos de ventas este mes.</p>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Peak Hours -->
      <mat-card class="analytics-card peak-hours">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>schedule</mat-icon>
            Horas Pico
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="heatmap-container">
            <div *ngFor="let hour of stats.peakHours" class="hour-bar-wrapper">
              <div class="hour-bar" [style.height.%]="(hour.count / getMaxHourCount()) * 100"
                [matTooltip]="hour.count + ' pedidos a las ' + hour.hour + ':00'">
                <div class="bar-fill"></div>
              </div>
              <span class="hour-label" *ngIf="hour.hour % 4 === 0">{{ hour.hour }}h</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Watermark for PDF -->
  <div class="watermark">Man√°</div>
</div>